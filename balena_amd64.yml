# these files exist separately because
# - VersionBot kills comments https://github.com/product-os/versionbot/issues/256
# - we need to versions to produce two different outputs

type: transformer@1.0.0
name: Transformer Template
version: 1.4.0
data:
  $transformer:
    baseSlug: template-amd64
    platforms:
      linux/amd64: {} # the exact same transformer only makes sense on a single architecture. We use amd64 and emulate everywhere for now

    # must all be encrypted with prod secret
    encryptedSecrets:
      buildSecrets:
        NPM_TOKEN: >-
          WjdzolKFfsMp0xMxPOEpZizVEFPjKj6nwHzecYlVupHN13JT033Iz6FR4NgUUAkT7W6DHVM+pWPGCQi0hfd/KM5D5bdJLvLYNsTRAC7LUQancYIXy8Zt3BDR6JNeoRVCU8dGjnOX1wflcXgeP/4a9SMuuh5MD3lFzWuW8DYMKDcAchv9hNg5ZXp6ofwsA/QQ589fyrG7FtjozWRL/iBR9nsdh4lvWq3jZvJv1gl215HCMI+oeW6sP9VSBElq/QzH63Nscup+JbsEkTjIzh75s41Jhf0JwKT+1IL/Qcs7jTLwMZ4XEsHArSHD1imZtcj+FvPTebGpH2Tp8zEwVar0jQ==

  # no idea yet, how to automatically create these two lines
  # for now flip two yml files
  targetPlatform: linux/amd64 # this field means  "I am building images for this"

  backflowMapping:
    - upstreamPath:
        $$formula: >-
          CONCATENATE("data.platforms['", this.downstream.data.platform, "'].image")
      downstreamValue:
        $$formula: >-
          CONCATENATE(this.downstream.slug, ":", this.downstream.version)

  inputFilter:
    type: object
    required:
      - type
      - data
    properties:
      type:
        const: service-source@1.0.0
      data:
        type: object
        required: # could think about making this optional and default to amd64...
          - platforms
        properties:
          platforms:
            type: object
            required:
              - linux/amd64 # see above

  requirements: {}

  workerFilter:
    type: object
    required:
      - type
    properties:
      type:
        const: transformer-worker@1.0.0
